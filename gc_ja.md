# Nimのガベージコレクター

原著：Andreas Rumpf
原文：[https://nim-lang.org/docs/gc.html](https://nim-lang.org/docs/gc.html)
Version：1.02

> 「地獄への道は善意で舗装されています。」

## イントロダクション(Introduction)
このドキュメントでは、GCの仕組みと（ソフト）リアルタイムシステム用にGCを調整する方法について説明します。

基本的なアルゴリズムは、サイクル検出による遅延参照カウントです。
スタック上の参照は、パフォーマンスの向上（およびCコード生成の容易化）のためにカウントされません。
現在、サイクル検出は単純なマーク&スイープGCによって実行されます。これは全て（スレッドローカルヒープ）をスキャンする必要があります。
`--gc：v2`は、これをインクリメンタルマーク&スイープに置き換えます。ただし、まだ正式版の準備ができていません。

GCは、メモリ割り当て操作でのみトリガーされます。タイマーによってはトリガーされず、バックグラウンドスレッドでは実行されません。

完全なコレクションを強制するには`GC_fullCollect`を呼び出します。一般に、GCに処理を行わせ、完全なコレクションを強制しない方が良いことに注意してください。

## サイクルコレクター(Cycle collector)
サイクルコレクターは、`GC_enableMarkAndSweep`および`GC_disableMarkAndSweep`を使用して、GCの他の部分から独立して有効化/無効化できます。

## リアルタイムサポート(Realtime support)
リアルタイムサポートを有効にするには、シンボルuseRealtimeGCを`--define:useRealtimeGC`で定義する必要があります（これをconfigファイルに追加することもできます）。
このスイッチを使用すると、GCは次の操作をサポートします。

```nim
proc GC_setMaxPause*(maxPauseInUs: int)
proc GC_step*(us: int, strongAdvice = false, stackSize = -1)
```

パラメーター`maxPauseInUs`および`us`の単位はマイクロ秒です。

これらの2つのプロシージャは、リアルタイムGCの2つの運用法です。

(1) GC_SetMaxPause Mode
> プログラムの起動時に`GC_SetMaxPause`を呼び出すと、トリガーされた各GCの実行が`maxPause`時間より長くかからないようにします。
ただし、`new`を呼び出すたびにGCがトリガーされ、`maxPause`時間がかかるため 、作業が均等に分散されない可能性があります（そして一般的にそうなります）。

(2) GC_step Mode
> これにより、GCに最大`us`マイクロ秒の間、処理を実行させることができます。
これは、メインループでGCを呼び出して、機能することを確認するのに役立ちます。
すべてのGCアクティビティを`GC_step`呼び出しにバインドするには、プログラムの起動時に`GC_disable`でGCを非アクティブ化します。
`strongAdvice`が`true`に設定されている場合、GCは収集サイクルの実行を強制されます。
そうしないと、収集するガベージがあまりない場合、GCは何もしないことを決定する場合があります。
`stackSize`パラメーターを使用して、現在のスタックサイズを指定することもできます。
スタック上の特定のポイントより下にユニークなNim参照がないことがわかっている場合、パフォーマンスを改善できます。
指定するサイズが、潜在的に最悪なケースのサイズよりも大きいことを確認してください。

これらのプロシージャは、「ベストエフォート」のリアルタイム保証を提供します。
特に、サイクルコレクターはまだ期限を認識していません。
これを無効にすると、より予測可能なリアルタイムの動作が得られます。
テストでは、最新のCPU（サイクルコレクターを無効にした場合）のほとんどすべてのケースで2msの最大休止時間が満たされることが示されています。

### 時間測定(Time measurement)
GCの時間測定方法（実装については`lib/system/timers.nim`を参照）：

- Windowsの`QueryPerformanceCounter`および`QueryPerformanceFrequency`
- Mac OS Xの`mach_absolute_time`
- Posixシステムの`gettimeofday`

そのため、内部でナノ秒の解像度をサポートしています。
ただし、便宜上、APIはマイクロ秒を使用します。

シンボル`reportMissedDeadlines`を定義して、期限に間に合わなかった場合にGC出力を作成します。
コレクターの以降のバージョンでは、APIによってレポート機能が強化されサポートされます。

### GCの調整(Tweaking the GC)

### メモリの追跡(Keeping track of memory)

## ヒープダンプ(Heap dump)

### ガベージコレクターオプション(Garbage collector options)
